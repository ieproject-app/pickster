<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Random Name Picker</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js CDN -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- App Alpine Data -->
  <script>
    function picksterApp() {
      return {
        // --- Data ---
        namesInput: '',
        allNames: [],
        availableNames: [],
        winners: [],
        lastWinners: [],
        selectionHistory: [],
        // --- Pengaturan ---
        numWinners: 1,
        shuffleDuration: 3,
        countdownDuration: 3,
        removeAfterPicking: true,
        // --- UI State ---
        isPicking: false,
        isCountingDown: false,
        countdownValue: 3,
        showConfetti: false,
        isSoundEnabled: true,
        isHistorySheetOpen: false,
        isPresentationMode: false,
        // --- Grup ---
        savedGroups: {},
        activeGroup: null,
        newGroupName: '',
        // --- Init ---
        init() {
          const d = localStorage.getItem('picksterState');
          if (d) {
            const j = JSON.parse(d);
            this.allNames = j.allNames || [];
            this.availableNames = j.availableNames || [...this.allNames];
            this.winners = j.winners || [];
            this.lastWinners = j.lastWinners || [];
            this.selectionHistory = j.selectionHistory || [];
            this.numWinners = j.numWinners || 1;
            this.shuffleDuration = j.shuffleDuration || 3;
            this.countdownDuration = j.countdownDuration || 3;
            this.removeAfterPicking = j.removeAfterPicking ?? true;
            this.savedGroups = j.savedGroups || {};
            this.activeGroup = j.activeGroup || null;
            this.isSoundEnabled = j.isSoundEnabled ?? true;
            // Ambil namesInput dari activeGroup atau join allNames
            if (this.activeGroup && this.savedGroups[this.activeGroup]) {
              this.namesInput = this.savedGroups[this.activeGroup].join('\n');
            } else {
              this.namesInput = this.allNames.join('\n');
            }
          }
        },
        saveStateToLocalStorage() {
          localStorage.setItem('picksterState', JSON.stringify({
            allNames: this.allNames,
            availableNames: this.availableNames,
            winners: this.winners,
            lastWinners: this.lastWinners,
            selectionHistory: this.selectionHistory,
            numWinners: this.numWinners,
            shuffleDuration: this.shuffleDuration,
            countdownDuration: this.countdownDuration,
            removeAfterPicking: this.removeAfterPicking,
            savedGroups: this.savedGroups,
            activeGroup: this.activeGroup,
            isSoundEnabled: this.isSoundEnabled
          }));
        },
        // --- Input Nama ---
        handleSetNames() {
          let names = this.namesInput.split('\n')
            .map(n => n.trim())
            .filter(n => n)
            .filter((v, i, a) => a.indexOf(v) === i);
          this.allNames = [...names];
          this.availableNames = [...names];
          this.winners = [];
          this.lastWinners = [];
          this.selectionHistory = [];
          this.activeGroup = null;
          this.saveStateToLocalStorage();
        },
        // --- Pengaturan Input Validasi ---
        validateNumWinners() {
          if (this.numWinners < 1) this.numWinners = 1;
        },
        validateShuffleDuration() {
          if (this.shuffleDuration < 1) this.shuffleDuration = 1;
        },
        validateCountdownDuration() {
          if (this.countdownDuration < 1) this.countdownDuration = 1;
        },
        // --- PICK WINNER ---
        startPickingProcess() {
          if (this.isCountingDown || this.isPicking) return;
          if (this.availableNames.length < this.numWinners) {
            alert('Jumlah nama tersedia tidak cukup untuk jumlah pemenang!');
            return;
          }
          // Hitung Mundur
          this.isCountingDown = true;
          this.countdownValue = this.countdownDuration;
          let countdownInterval = setInterval(() => {
            this.playTick();
            if (this.countdownValue > 1) {
              this.countdownValue--;
            } else {
              clearInterval(countdownInterval);
              this.isCountingDown = false;
              // Tentukan pemenang
              const shuffled = this.fisherYatesShuffle([...this.availableNames]);
              const winners = shuffled.slice(0, this.numWinners);
              this.lastWinners = winners;
              // Mulai animasi shuffle
              this.animateShuffle(winners);
            }
          }, 1000);
        },
        // --- SHUFFLE ANIMATION ---
        animateShuffle(finalWinners) {
          this.isPicking = true;
          let allNames = [...this.availableNames];
          let duration = this.shuffleDuration * 1000;
          let start = Date.now();
          let showNames = [];
          const shuffleLoop = () => {
            if (!this.isPicking) return;
            let now = Date.now();
            if (now - start < duration) {
              // acak dan tampilkan N nama random
              showNames = this.fisherYatesShuffle([...allNames]).slice(0, this.numWinners);
              this.lastWinners = showNames;
              setTimeout(shuffleLoop, 70);
            } else {
              // Akhiri animasi, tampilkan pemenang sebenarnya
              this.isPicking = false;
              this.lastWinners = finalWinners;
              this.processWinners(finalWinners);
            }
          };
          shuffleLoop();
        },
        // --- Proses Setelah Pemenang Ditetapkan ---
        processWinners(winners) {
          // Efek suara & confetti
          this.playWin();
          this.showConfetti = true;
          setTimeout(() => this.showConfetti = false, 2500);
          // Update state
          this.winners.push(...winners);
          if (this.removeAfterPicking) {
            this.availableNames = this.availableNames.filter(n => !winners.includes(n));
          }
          // Update history (terbalik)
          this.selectionHistory.unshift({
            time: new Date().toISOString(),
            winners: [...winners]
          });
          this.saveStateToLocalStorage();
        },
        // --- SHUFFLE ---
        fisherYatesShuffle(arr) {
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
          return arr;
        },
        // --- GRUP ---
        handleSaveGroup() {
          if (!this.newGroupName.trim()) {
            alert('Nama grup tidak boleh kosong!');
            return;
          }
          this.savedGroups[this.newGroupName] = [...this.allNames];
          this.activeGroup = this.newGroupName;
          this.saveStateToLocalStorage();
          this.newGroupName = '';
        },
        handleLoadGroup(groupName) {
          if (!this.savedGroups[groupName]) return;
          this.activeGroup = groupName;
          this.allNames = [...this.savedGroups[groupName]];
          this.availableNames = [...this.allNames];
          this.namesInput = this.allNames.join('\n');
          this.winners = [];
          this.lastWinners = [];
          this.selectionHistory = [];
          this.saveStateToLocalStorage();
        },
        handleDeleteGroup(groupName) {
          if (confirm(`Hapus grup "${groupName}"?`)) {
            delete this.savedGroups[groupName];
            if (this.activeGroup === groupName) {
              this.activeGroup = null;
              this.allNames = [];
              this.availableNames = [];
              this.namesInput = '';
            }
            this.saveStateToLocalStorage();
          }
        },
        // --- PRESENTATION MODE ---
        startPresentationMode() {
          this.isPresentationMode = true;
          this.$nextTick(() => {
            this.$el.requestFullscreen && this.$el.requestFullscreen();
          });
        },
        exitPresentationMode() {
          this.isPresentationMode = false;
          if (document.fullscreenElement) {
            document.exitFullscreen && document.exitFullscreen();
          }
        },
        // --- HISTORY ---
        openHistorySheet() {
          this.isHistorySheetOpen = true;
        },
        closeHistorySheet() {
          this.isHistorySheetOpen = false;
        },
        // --- SOUND ---
        playTick() {
          if (!this.isSoundEnabled) return;
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, ctx.currentTime);
            gain.gain.setValueAtTime(0.12, ctx.currentTime);
            osc.connect(gain).connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.09);
            osc.onended = () => ctx.close();
          } catch (e) {}
        },
        playWin() {
          if (!this.isSoundEnabled) return;
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const notes = [523, 659, 784, 1047, 784, 659, 523];
            notes.forEach((f, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.setValueAtTime(f, ctx.currentTime + i * 0.09);
              gain.gain.setValueAtTime(0.17, ctx.currentTime + i * 0.09);
              gain.gain.linearRampToValueAtTime(0, ctx.currentTime + (i + 1) * 0.09 + 0.04);
              osc.connect(gain).connect(ctx.destination);
              osc.start(ctx.currentTime + i * 0.09);
              osc.stop(ctx.currentTime + (i + 1) * 0.09 + 0.04);
            });
            setTimeout(() => ctx.close(), 700);
          } catch (e) {}
        },
        // --- CONFETTI ---
        // CSS-only confetti, see HTML for implementation
      }
    }
  </script>
  <!-- Confetti CSS -->
  <style>
    .confetti {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 100;
    }
    .confetti-piece {
      position: absolute;
      width: 10px; height: 20px;
      opacity: 0.8;
      border-radius: 2px;
      animation: confetti-fall 2.5s linear forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-30px) rotateZ(0); }
      100% { transform: translateY(100vh) rotateZ(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="picksterApp()" x-init="init()" 
      :class="{'overflow-hidden': isPresentationMode || isHistorySheetOpen}"
      @keydown.window.space.prevent="isPresentationMode && startPickingProcess()"
      @keydown.window.escape="isPresentationMode && exitPresentationMode()">

  <!-- Confetti Overlay -->
  <template x-if="showConfetti">
    <div class="confetti">
      <template x-for="i in 80">
        <div class="confetti-piece"
          :style="{
            left: `${Math.random() * 100}%`,
            background: `hsl(${Math.random()*360},90%,70%)`,
            animationDelay: `${Math.random()}s`,
            transform: `rotate(${Math.random()*360}deg)`
          }"></div>
      </template>
    </div>
  </template>
  <!-- History Sheet -->
  <div x-show="isHistorySheetOpen"
       class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-end md:items-center justify-center"
       x-transition>
    <div class="bg-white w-full md:w-[600px] max-h-[90vh] rounded-t-2xl md:rounded-2xl shadow-lg p-6 overflow-y-auto relative">
      <button @click="closeHistorySheet()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <h2 class="text-xl font-bold mb-4">Riwayat Pemenang</h2>
      <template x-if="selectionHistory.length === 0">
        <div class="text-gray-500 italic">Belum ada riwayat.</div>
      </template>
      <ol class="space-y-2">
        <template x-for="(entry, idx) in selectionHistory" :key="entry.time">
          <li>
            <div class="text-sm text-gray-400">#<span x-text="selectionHistory.length - idx"></span> - <span x-text="new Date(entry.time).toLocaleString()"></span></div>
            <div class="flex flex-wrap gap-2 mt-1">
              <template x-for="name in entry.winners">
                <span class="bg-green-100 text-green-800 rounded px-3 py-1 font-semibold text-lg" x-text="name"></span>
              </template>
            </div>
          </li>
        </template>
      </ol>
    </div>
  </div>
  <!-- Presentation Mode Overlay -->
  <div x-show="isPresentationMode" class="fixed inset-0 bg-black bg-opacity-95 z-40 flex flex-col items-center justify-center"
    x-transition>
    <button @click="exitPresentationMode" class="absolute top-4 right-4 text-white/70 hover:text-white text-2xl">
      &times;
    </button>
    <div class="w-full h-full flex flex-col items-center justify-center">
      <template x-if="isCountingDown">
        <div class="text-[7vw] font-black text-yellow-300 animate-bounce drop-shadow-lg select-none" x-text="countdownValue"></div>
      </template>
      <template x-if="!isCountingDown && lastWinners.length">
        <div
          :class="{
            'flex flex-col gap-8 items-center justify-center': lastWinners.length <= 4,
            'grid grid-cols-2 md:grid-cols-3 gap-8': lastWinners.length > 4 && lastWinners.length <= 9,
            'grid grid-cols-3 md:grid-cols-4 gap-4': lastWinners.length > 9
          }"
          class="mt-8"
        >
          <template x-for="name in lastWinners">
            <div
              :class="{
                'text-[6vw] font-extrabold text-white bg-blue-500/90 px-12 py-6 rounded-2xl shadow-lg': lastWinners.length <= 4,
                'text-[3vw] font-bold text-white bg-blue-600/80 px-8 py-3 rounded-xl shadow-md': lastWinners.length > 4 && lastWinners.length <= 9,
                'text-[2vw] font-bold text-white bg-blue-700/80 px-6 py-2 rounded-lg shadow': lastWinners.length > 9
              }"
              x-text="name"
            ></div>
          </template>
        </div>
      </template>
    </div>
  </div>
  <!-- Main Layout -->
  <div class="container mx-auto p-4 md:p-8" :class="{ 'pointer-events-none blur-sm select-none': isPresentationMode || isHistorySheetOpen }">
    <div class="flex flex-col md:flex-row gap-6">
      <!-- Left Column: Input & Pengaturan -->
      <div class="md:w-1/2 w-full flex flex-col gap-6">
        <!-- Tab Nama/Grup -->
        <div class="flex gap-2 mb-2">
          <button :class="{'bg-blue-700 text-white': !activeGroup, 'bg-white text-blue-700': activeGroup}"
                  class="flex-1 px-4 py-2 rounded-t-lg font-semibold border border-b-0 border-blue-200"
                  @click="activeGroup = null; namesInput = allNames.join('\n')">
            Daftar Baru
          </button>
          <button :class="{'bg-blue-700 text-white': activeGroup, 'bg-white text-blue-700': !activeGroup}"
                  class="flex-1 px-4 py-2 rounded-t-lg font-semibold border border-b-0 border-blue-200"
                  @click="activeGroup = Object.keys(savedGroups)[0] || null; if (activeGroup) handleLoadGroup(activeGroup)">
            Grup
          </button>
        </div>
        <!-- Input Nama -->
        <div x-show="!activeGroup" class="bg-white rounded-b-lg shadow p-4">
          <label class="block font-semibold mb-2">Masukkan daftar nama (1 baris per nama):</label>
          <textarea x-model="namesInput"
                    class="w-full h-40 rounded border p-2 font-mono text-lg bg-gray-50 focus:outline-none focus:border-blue-400 resize-y"
                    placeholder="Contoh:
Andi
Budi
Cici"></textarea>
          <button
            @click="handleSetNames"
            class="mt-3 px-4 py-2 rounded bg-blue-700 text-white font-semibold hover:bg-blue-800 transition shadow">
            Set List
          </button>
        </div>
        <!-- Manajemen Grup -->
        <div x-show="activeGroup" class="bg-white rounded-b-lg shadow p-4">
          <label class="block font-semibold mb-2">Grup Tersimpan:</label>
          <div class="flex flex-wrap gap-2 mb-2">
            <template x-for="g in Object.keys(savedGroups)">
              <div class="flex items-center gap-1">
                <button
                  @click="handleLoadGroup(g)"
                  :class="{'bg-blue-600 text-white': activeGroup === g, 'bg-blue-100 text-blue-700': activeGroup !== g}"
                  class="px-3 py-1 rounded font-semibold hover:bg-blue-700 hover:text-white transition"
                  x-text="g"></button>
                <button @click="handleDeleteGroup(g)" class="text-red-400 hover:text-red-700 text-sm ml-1">&times;</button>
              </div>
            </template>
          </div>
          <div class="mt-3">
            <input type="text" x-model="newGroupName" placeholder="Nama grup baru"
                   class="border px-2 py-1 rounded mr-2">
            <button @click="handleSaveGroup"
                class="px-3 py-1 rounded bg-green-600 text-white font-semibold hover:bg-green-700 transition">
              Simpan Grup
            </button>
          </div>
        </div>
        <!-- Pengaturan -->
        <div class="bg-white rounded-lg shadow p-4">
          <details open>
            <summary class="text-lg font-semibold cursor-pointer mb-2">Pengaturan</summary>
            <div class="flex flex-col gap-3 mt-2">
              <label class="flex items-center gap-2">Jumlah Pemenang:
                <input type="number" min="1" x-model.number="numWinners" @input="validateNumWinners"
                  class="w-16 border rounded px-2 py-1 ml-2">
              </label>
              <label class="flex items-center gap-2">Durasi Shuffle (detik):
                <input type="number" min="1" x-model.number="shuffleDuration" @input="validateShuffleDuration"
                  class="w-16 border rounded px-2 py-1 ml-2">
              </label>
              <label class="flex items-center gap-2">Durasi Hitung Mundur:
                <input type="number" min="1" x-model.number="countdownDuration" @input="validateCountdownDuration"
                  class="w-16 border rounded px-2 py-1 ml-2">
              </label>
              <label class="flex items-center gap-2">Remove After Picking:
                <input type="checkbox" x-model="removeAfterPicking" class="ml-2 rounded accent-blue-700">
              </label>
              <label class="flex items-center gap-2">Bunyikan Suara:
                <input type="checkbox" x-model="isSoundEnabled" class="ml-2 rounded accent-blue-700">
              </label>
            </div>
          </details>
        </div>
        <!-- Info Sisa Nama -->
        <div class="bg-white rounded-lg shadow p-4 flex items-center gap-2">
          <span class="font-semibold">Sisa nama tersedia:</span>
          <span class="text-blue-800 font-extrabold text-lg" x-text="availableNames.length"></span>
          <span class="ml-auto text-sm text-gray-400" x-text="`Total: ${allNames.length}`"></span>
        </div>
      </div>
      <!-- Right Column: Hasil & Kontrol -->
      <div class="md:w-1/2 w-full flex flex-col gap-6">
        <!-- Hasil & Shuffle -->
        <div class="bg-white rounded-lg shadow p-4 flex flex-col items-center justify-center min-h-[200px]">
          <template x-if="isCountingDown">
            <div class="text-7xl font-black text-yellow-400 animate-pulse select-none" x-text="countdownValue"></div>
          </template>
          <template x-if="isPicking && !isCountingDown">
            <div class="text-lg text-blue-400 animate-pulse">Memilih...</div>
          </template>
          <template x-if="!isCountingDown && !isPicking && lastWinners.length">
            <div
              :class="{
                'flex flex-col gap-4 items-center justify-center': lastWinners.length <= 4,
                'grid grid-cols-2 md:grid-cols-3 gap-4': lastWinners.length > 4 && lastWinners.length <= 9,
                'grid grid-cols-3 md:grid-cols-4 gap-2': lastWinners.length > 9
              }"
            >
              <template x-for="name in lastWinners">
                <div
                :class="{
                  'text-4xl font-extrabold text-white bg-blue-600 px-8 py-4 rounded-2xl shadow-lg': lastWinners.length <= 4,
                  'text-2xl font-bold text-white bg-blue-500 px-4 py-2 rounded-lg shadow-md': lastWinners.length > 4 && lastWinners.length <= 9,
                  'text-base font-semibold text-white bg-blue-400 px-2 py-1 rounded shadow': lastWinners.length > 9
                }"
                x-text="name"></div>
              </template>
            </div>
          </template>
          <template x-if="!isCountingDown && !isPicking && !lastWinners.length">
            <div class="text-gray-400 font-semibold">Belum ada pemenang.</div>
          </template>
        </div>
        <!-- Kontrol -->
        <div class="flex flex-wrap gap-3 items-center justify-center">
          <button
            @click="startPickingProcess"
            :disabled="isPicking || isCountingDown || availableNames.length < numWinners"
            class="px-6 py-3 rounded-lg bg-green-700 text-white font-bold text-lg shadow hover:bg-green-800 transition disabled:opacity-50">
            Pick Winner(s)
          </button>
          <button
            @click="startPresentationMode"
            class="px-6 py-3 rounded-lg bg-pink-600 text-white font-bold text-lg shadow hover:bg-pink-700 transition">
            Mode Presentasi
          </button>
          <button
            @click="openHistorySheet"
            class="px-6 py-3 rounded-lg bg-yellow-500 text-white font-bold text-lg shadow hover:bg-yellow-600 transition">
            View History
          </button>
        </div>
        <!-- Sisa Nama List -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold mb-2 text-gray-700">Nama yang belum menang:</h3>
          <div class="flex flex-wrap gap-2">
            <template x-for="name in availableNames">
              <span class="bg-blue-100 text-blue-800 rounded px-3 py-1 text-sm font-semibold" x-text="name"></span>
            </template>
            <template x-if="availableNames.length === 0">
              <span class="text-gray-400">Tidak ada nama tersisa.</span>
            </template>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <div class="mt-10 text-center text-xs text-gray-400">
      Random Name Picker &copy; 2025 &middot; Built with <a href="https://alpinejs.dev/" class="text-blue-500 hover:underline">Alpine.js</a> &amp; <a href="https://tailwindcss.com/" class="text-blue-500 hover:underline">Tailwind CSS</a>
      <br>
      <span class="italic">Tip: Gunakan <kbd class="bg-gray-200 px-1 rounded">Space</kbd> dan <kbd class="bg-gray-200 px-1 rounded">Esc</kbd> untuk kontrol di Mode Presentasi.</span>
    </div>
  </div>
</body>
</html>
